---
- name: Setup K8s nodes with matrix strategy
  hosts: all
  become: true
  remote_user: "core"
  vars:
    node_config:
      old_k3s_install_command: "/bin/bash -c 'exec /usr/bin/curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=\"server\" sh -s -'"
      master_init_server: "ada0.lan"
      init_server:
        hosts:
          - "ada0.lan"
        write_server_url_to: "/dev/null"
        k3s_install_exec: "server"
      join_server:
        hosts:
          - "ada1.lan"
        write_server_url_to: "/etc/rancher/k3s/config.yaml.d/20_server_url_config.yaml"
        k3s_install_exec: "server"
      agent:
        hosts:
          - "ada2.lan"
          - "ada3.lan"
          - "ada4.lan"
        write_server_url_to: "/etc/rancher/k3s/config.yaml.d/20_server_url_config.yaml"
        k3s_install_exec: "agent"

  tasks:
    - name: Layer k3s-selinux into rpm-ostree
      command: rpm-ostree install k3s-selinux
      become: true
      register: rpm_ostree_result

    - name: Reboot if needed
      reboot:
      become: true
      when: rpm_ostree_result.changed

    - name: Determine node type
      set_fact:
        node_type: >-
          {{
            'init_server' if inventory_hostname in node_config.init_server.hosts
            else 'join_server' if inventory_hostname in node_config.join_server.hosts
            else 'agent'
          }}

    - name: Write the master init-server url # ... so join-servers and agents can join the cluster
      copy:
        dest: "{{ node_config[node_type].write_server_url_to }}"
        content: |
          # configs for agent nodes and join-server nodes
          # this file should not exist on init-server nodes
          
          # the url of the server node to initially connect to during setup in order to join the cluster
          "server: https://{{ node_config.master_init_server }}"
        mode: "0644"

    - name: Download K3s installer
      get_url:
        url: https://get.k3s.io
        dest: /usr/local/bin/k3s-install.sh
        mode: '0755'

    - name: Install k3s using downloaded installer
      command: bash -lc '/tmp/k3s-install.sh'
      environment:
        INSTALL_K3S_EXEC: "{{ node_config[node_type].k3s_install_exec }}"
        INSTALL_K3S_SKIP_SELINUX_RPM: "true"  # Skip SELinux check that requires rpm-ostree
        INSTALL_K3S_SKIP_START: "true"  # Don't start the service yet - we need to patch the systemd unit so it works on core-os
      become: true

    - name: Install k3s using systemd-run for proper service context
      command: systemd-run --wait --pipe --setenv=INSTALL_K3S_EXEC="{{ node_config[node_type].k3s_install_exec }}" /usr/local/bin/k3s-install.sh
      become: true

    - name: Reload systemd daemon
      systemd:
        daemon_reload: true
      become: true

    - name: Enable and start k3s service
      systemd:
        name: k3s
        enabled: true
        state: started
      become: true
